

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Foolscap Logging Formats &mdash; Foolscap v0.6.1 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Foolscap v0.6.1 documentation" href="../index.html" />
    <link rel="next" title="NewPB" href="pb.html" />
    <link rel="prev" title="The Banana Protocol" href="banana.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pb.html" title="NewPB"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="banana.html" title="The Banana Protocol"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Foolscap v0.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="foolscap-logging-formats">
<h1>Foolscap Logging Formats<a class="headerlink" href="#foolscap-logging-formats" title="Permalink to this headline">¶</a></h1>
<p>This document describes the Foolscap logging format. Foolscap logging uses
event dictionaries in memory. Certain tools will serialize these events onto
disk. These on-disk files may have additional metadata stored in adjunct
index files. This document describes the formats of all these objects.</p>
<div class="section" id="events">
<h2>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>Each call to <tt class="docutils literal"><span class="pre">log.msg</span></tt> produces an <strong>event</strong> . These events
are stored in memory as dictionaries, with the following keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">num</span></tt> (integer): this defines a full ordering of events
within a single invocation of a program. The counter that produces these is
maintained in the singleton <tt class="docutils literal"><span class="pre">FoolscapLogger</span></tt> instance known as
<tt class="docutils literal"><span class="pre">log.theLogger</span></tt> .</li>
<li><tt class="docutils literal"><span class="pre">time</span></tt> (float): the time at which <tt class="docutils literal"><span class="pre">log.msg</span></tt> was
called.</li>
<li><tt class="docutils literal"><span class="pre">incarnation</span></tt> (pair of binary strings or Nones): the
&#8220;incarnation record&#8221;, used to distinguish between distinct invocations of
the same program/Tub. Each time the program is started, it gets a distinct
incarnation record. The IR contains a (unique, sequential) tuple of values.
&#8216;unique&#8217; is a random binary string. At present, &#8216;sequential&#8217; is always
None. In a future release, Tubs which are given persistent storage will use
an incrementing integer as &#8216;sequential&#8217;, to allow total ordering of events
from multiple incarnations. Without &#8216;sequential&#8217;, events from one
invocation of the program cannot be reliably sorted with respect to events
from other invocations (except by timestamp, which depends upon comparable
clocks).</li>
<li><tt class="docutils literal"><span class="pre">level</span></tt> (integer): the severity level of the event. These
are typically obtained by using one of the pre-defined constants like
<tt class="docutils literal"><span class="pre">log.NOISY</span></tt> (10), <tt class="docutils literal"><span class="pre">log.WEIRD</span></tt> (30), or
<tt class="docutils literal"><span class="pre">log.BAD</span></tt> (40). The default value is
<tt class="docutils literal"><span class="pre">log.OPERATIONAL</span></tt> (20).</li>
<li><tt class="docutils literal"><span class="pre">facility</span></tt> (string, optional): a facility name, like
<tt class="docutils literal"><span class="pre">foolscap.negotiation</span></tt> . Strings are unconstrained, but foolscap
tools are designed to treat the facility as a big-endian period-separated
hierarchical list, i.e. <tt class="docutils literal"><span class="pre">foolscap.negotiation</span></tt> and
<tt class="docutils literal"><span class="pre">foolscap.promises</span></tt> would be related. One such tool would be the
<tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">filter</span> <span class="pre">--strip-facility</span> <span class="pre">&quot;foolscap&quot;</span></tt> command.</li>
<li><tt class="docutils literal"><span class="pre">message</span></tt> (string, optional): the logged message. The first
positional argument to <tt class="docutils literal"><span class="pre">log.msg</span></tt> will be stored here. All
messages will either have <tt class="docutils literal"><span class="pre">[&quot;message&quot;]</span></tt> or
<tt class="docutils literal"><span class="pre">[&quot;format&quot;]</span></tt> .</li>
<li><tt class="docutils literal"><span class="pre">format</span></tt> (string, optional): a printf-style format
specification string for the message. When the message is turned into a
string, the event dictionary will be used for the string format operation,
so <tt class="docutils literal"><span class="pre">log.msg(format=&quot;%(count)d</span> <span class="pre">apples&quot;,</span> <span class="pre">count=4)</span></tt> is a more
structured way to say <tt class="docutils literal"><span class="pre">log.msg(&quot;%d</span> <span class="pre">apples&quot;</span> <span class="pre">%</span> <span class="pre">count)</span></tt> . By using
<tt class="docutils literal"><span class="pre">format=</span></tt> and delaying string interpolation until later,
log-analysis tools will have more information to work with.</li>
<li><tt class="docutils literal"><span class="pre">isError</span></tt> (integer, optional): <tt class="docutils literal"><span class="pre">log.err</span></tt> will set
this to 1. <tt class="docutils literal"><span class="pre">log.msg</span></tt> will not set this. This is a simple test to
see which entry point was used to record the message.</li>
<li><tt class="docutils literal"><span class="pre">failure</span></tt> (Failure instance, optional): if
<tt class="docutils literal"><span class="pre">[&quot;failure&quot;]</span></tt> is present, formatting tools will render a brief
traceback. The first positional argument to <tt class="docutils literal"><span class="pre">log.err</span></tt> will be
stored here.</li>
<li><tt class="docutils literal"><span class="pre">stacktrace</span></tt> (list of strings, optional): if
<tt class="docutils literal"><span class="pre">log.msg</span></tt> is called with <tt class="docutils literal"><span class="pre">stacktrace=True</span></tt> , then
<tt class="docutils literal"><span class="pre">traceback.format_stack()</span></tt> will be used to generate a stack
trace string, storing it in this key.</li>
</ul>
<p>In addition to these keys, all other keyword arguments to the``log.msg`` and <tt class="docutils literal"><span class="pre">log.err</span></tt> calls are recorded in the event
dictionary. Some keys are reserved: those that begin with an underscore, and
those that are not legal python identifiers (i.e. they contain dots). Some of
these reserved keys are used for internal purposes.</p>
<p>Developers are encouraged to store log parameters with keyword arguments
rather than with string interpolation into the <tt class="docutils literal"><span class="pre">message=</span></tt>
argument, so that later analysis/filtering tools can take advantage of it.
For example, if you use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&quot;Uploading </span><span class="si">%(size)d</span><span class="s"> byte file&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">SIZE</span><span class="p">)</span>
</pre></div>
</div>
<p>instead of:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Uploading </span><span class="si">%d</span><span class="s"> byte file&quot;</span> <span class="o">%</span> <span class="n">SIZE</span><span class="p">)</span>
</pre></div>
</div>
<p>Then later, you can write a filter expression that can do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_big_uploads</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s">&quot;format&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Uploading </span><span class="si">%(size)d</span><span class="s"> byte file&quot;</span> <span class="ow">and</span>
                <span class="n">e</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">subset</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_big_uploads</span><span class="p">,</span> <span class="n">all_events</span><span class="p">)</span>
</pre></div>
</div>
<p>Other tools will be provided in the future to make this more concise. This
also makes it easier to write filtering expressions that can be serialized
and sent over the wire, so that <tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">tail</span></tt> can subscribe to a
narrowly-defined subset of events, rather than to everything.</p>
</div>
<div class="section" id="logfiles">
<h2>Logfiles<a class="headerlink" href="#logfiles" title="Permalink to this headline">¶</a></h2>
<p>Several foolscap logging tools will record a sequence of events to disk:<tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">tail</span> <span class="pre">--save-to</span> <span class="pre">FILENAME</span></tt> and the gatherer created by``flogtool create-gatherer`` are two of them.</p>
<p>These tools know about two file formats, compressed and uncompressed. If
the filename ends in <tt class="docutils literal"><span class="pre">.bz2</span></tt> , then the file is opened with the``bzip`` module, but otherwise treated exactly like the uncompressed
form. No support is provided for gzip or other compression schemes.</p>
<p>The uncompressed save-file format contains a sequence of pickled &#8220;received
event wrapper dictionaries&#8221;. Each wrapper dict is pickled separately, such
that code which wants to iterate over the contents needs to call``pickle.load(f)`` repeatedly (this enables streaming
processing).</p>
<p>The wrapper dictionary is used to record some information that is not
stored in the event dictionary itself, sometimes because it is the same for
long runs of events from a single source (like the tubid that generated the
event). (TODO: some of this split is arbitrary and historical, and ought to
be cleaned up). The wrapper dictionary contains the following keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">from</span></tt> (base32 string): the TubID that recorded the
event.</li>
<li><tt class="docutils literal"><span class="pre">d</span></tt> (dictionary): the event dictionary defined above.</li>
<li><tt class="docutils literal"><span class="pre">rx_time</span></tt> (float): the time at which the recipient (e.g.
<tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">tail</span></tt> ) received the event. If the generator and the
recipient have synchronized clocks, then a significant delta between
<tt class="docutils literal"><span class="pre">e[&quot;rx_time&quot;]</span></tt> and <tt class="docutils literal"><span class="pre">e[&quot;d&quot;][&quot;time&quot;]</span></tt> indicates delays
in the event publishing process, possibly the result of reactor or network
load.</li>
</ul>
</div>
<div class="section" id="logfile-headers">
<h2>Logfile Headers<a class="headerlink" href="#logfile-headers" title="Permalink to this headline">¶</a></h2>
<p>The first wrapper dict in the logfile may be special: it contains**headers** . This header dict is distinguished by the fact that it does
not contain a <tt class="docutils literal"><span class="pre">[&quot;d&quot;]</span></tt> member. Instead, it contains a``[&#8220;header&#8221;]`` member. The tools which iterate over events in
logfiles know to ignore the wrapper dicts which lack a <tt class="docutils literal"><span class="pre">[&quot;d&quot;]</span></tt>
key.</p>
<p>On the other hand, the first wrapper dict might be a regular event. Older
versions of foolscap (0.2.5 and earlier) did not produce header dicts. Tools
which process logfiles must tolerate the lack of a header dict.</p>
<p>The header dict allows the logfile to be used for various purposes,
somewhat open-ended to allow for future extensions.</p>
<p>All header dicts contain a key named <tt class="docutils literal"><span class="pre">type</span></tt> that describe the
purpose of the logfile. The currently assigned values for type are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">log-file-observer</span></tt> : this indicates that the logfile was
created by a <tt class="docutils literal"><span class="pre">LogFileObserver</span></tt> instance, for example the one
created when the <tt class="docutils literal"><span class="pre">FLOGFILE=out.flog</span></tt> environment variable is
used.</li>
<li><tt class="docutils literal"><span class="pre">tail</span></tt> : this indicates that the logfile was created by the
<tt class="docutils literal"><span class="pre">--save-to</span></tt> option of <tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">tail</span></tt> .</li>
<li><tt class="docutils literal"><span class="pre">gatherer</span></tt> : the logfile was created by the foolscap
log-gatherer, for which the <tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">create-gatherer</span></tt> command
is provided.</li>
<li><tt class="docutils literal"><span class="pre">incident</span></tt> : the logfile was created by an application
as part of the incident reporting process.</li>
</ul>
<div class="section" id="log-file-observer">
<h3>log-file-observer<a class="headerlink" href="#log-file-observer" title="Permalink to this headline">¶</a></h3>
<p>The header dict produced by a <tt class="docutils literal"><span class="pre">LogFileObserver</span></tt> contains the
following additional keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">threshold</span></tt> (int): the severity threshold that was used for
this logfile: no events below the threshold will be saved.</li>
</ul>
<p>Also note that the wrapper dicts recorded by the``LogFileObserver`` will use a &#8220;from&#8221; value of &#8220;local&#8221;, instead of a
particular TubID, since these events are not recorded through a path that
uses any specific Tub.</p>
</div>
<div class="section" id="flogtool-tail">
<h3>flogtool tail<a class="headerlink" href="#flogtool-tail" title="Permalink to this headline">¶</a></h3>
<p>The header dict produced by <tt class="docutils literal"><span class="pre">flogtool</span> <span class="pre">tail</span></tt> contains the
following additional keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">pid</span></tt> (int): if present, this value contains the process id
of the process which was being followed by &#8216;flogtool tail&#8217;.</li>
<li><tt class="docutils literal"><span class="pre">versions</span></tt> (dict): this contains a dictionary of component
versions, mapping a string component name like &#8220;foolscap&#8221; to a version
string.</li>
</ul>
</div>
<div class="section" id="log-gatherer">
<h3>log-gatherer<a class="headerlink" href="#log-gatherer" title="Permalink to this headline">¶</a></h3>
<p>The header dict produced by the flogtool log-gatherer contains the
following additional keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">start</span></tt> (float): the time at which this logfile was first
opened.</li>
</ul>
</div>
<div class="section" id="incident-reports">
<h3>Incident Reports<a class="headerlink" href="#incident-reports" title="Permalink to this headline">¶</a></h3>
<p>An <strong>Incident Report</strong> is a logfile that was recorded because of an
important triggering event: a dump of the short-term history buffers that
saves the activity of the application just prior to the trigger. It can also
contain some number of subsequent events, to record recovery efforts or
additional information that is logged after the triggering event.</p>
<p>Incident Reports are distinguished by their header type:<tt class="docutils literal"><span class="pre">e[&quot;header&quot;][&quot;type&quot;]==&quot;incident&quot;</span></tt> . Their header dicts contain the
following additional keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">trigger</span></tt> (event dict): a copy of the event which triggered
the incident. This event will also be present somewhere in the rest of the
logfile, at its normal position in the event stream.</li>
<li><tt class="docutils literal"><span class="pre">pid</span></tt> (int): this value contains the process id of the
process which experienced the incident.</li>
<li><tt class="docutils literal"><span class="pre">versions</span></tt> (dict): this contains a dictionary of component
versions, mapping a string component name like &#8220;foolscap&#8221; to a version
string.</li>
</ul>
</div>
</div>
<div class="section" id="index-files">
<h2>Index Files<a class="headerlink" href="#index-files" title="Permalink to this headline">¶</a></h2>
<p>No index files have been defined yet. The vague idea is that each logfile
could contain a summary in an index file of the same name (but with an extra
.index suffix). This index would be used by other tools to quickly identify
what is inside the main file without actually reading the whole contents.</p>
<p>In addition, it may be possible to put a table of offsets into the index
file, to accelerate random-access reads of the main logfile (i.e. put the
offset of every 100 events into the index, reducing the worst-case access
time to two seeks and a read of no more than 100 events). Some sort of
restartable compression could make such an offset table useful for compressed
files as well.</p>
<p>These index files would need to exist as distinct files (rather than as a
header in the main logfile) because they are variable-size and cannot be
generated until after the main logfile is closed. Placing them at the start
of the main logfile would require rewriting or copying the whole file.
Further complications are present when the main logfile is compressed.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Foolscap Logging Formats</a><ul>
<li><a class="reference internal" href="#events">Events</a></li>
<li><a class="reference internal" href="#logfiles">Logfiles</a></li>
<li><a class="reference internal" href="#logfile-headers">Logfile Headers</a><ul>
<li><a class="reference internal" href="#log-file-observer">log-file-observer</a></li>
<li><a class="reference internal" href="#flogtool-tail">flogtool tail</a></li>
<li><a class="reference internal" href="#log-gatherer">log-gatherer</a></li>
<li><a class="reference internal" href="#incident-reports">Incident Reports</a></li>
</ul>
</li>
<li><a class="reference internal" href="#index-files">Index Files</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="banana.html"
                        title="previous chapter">The Banana Protocol</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pb.html"
                        title="next chapter">NewPB</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/specifications/logfiles.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pb.html" title="NewPB"
             >next</a> |</li>
        <li class="right" >
          <a href="banana.html" title="The Banana Protocol"
             >previous</a> |</li>
        <li><a href="../index.html">Foolscap v0.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Brian Warner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>