

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using Pass-By-Copy in Foolscap &mdash; Foolscap v0.6.1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Foolscap v0.6.1 documentation" href="index.html" />
    <link rel="next" title="Foolscap Failure Reporting" href="failures.html" />
    <link rel="prev" title="Introduction to Foolscap" href="using-foolscap.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="failures.html" title="Foolscap Failure Reporting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="using-foolscap.html" title="Introduction to Foolscap"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Foolscap v0.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-pass-by-copy-in-foolscap">
<h1>Using Pass-By-Copy in Foolscap<a class="headerlink" href="#using-pass-by-copy-in-foolscap" title="Permalink to this headline">¶</a></h1>
<p>Certain objects (including subclasses of <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.Copyable-class.html">foolscap.Copyable</a> and things for which an <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable.ICopyable-class.html">ICopyable</a> adapter has been
registered) are serialized using copy-by-value semantics. Each such object is
serialized as a (copytype, state) pair of values. On the receiving end, the
&#8220;copytype&#8221; is looked up in a table to find a suitable deserializer. The
&#8220;state&#8221; information is passed to this deserializer to create a new instance
that corresponds to the original. Note that the sending and receiving ends
are under no obligation to use the same class on each side: it is fairly
common for the remote form of an object to have different methods than the
original instance.</p>
<p>Copy-by-value (as opposed to copy-by-reference) means that the remote
representation of an object leads an independent existence, unconnected to
the original. Sending the same object multiple times will result in separate
independent copies. Sending the result of a pass-by-copy operation back to
the original sender will, at best, result in the sender holding two separate
objects containing similar state (and at worst will not work at all: not all
RemoteCopies are themselves Copyable).</p>
<p>More complex copy semantics can be accomplished by writing custom Slicer
code. For example, to get an object that is copied by value the first time it
traverses the wire, and then copied by reference all later times, you will
need to write a Slicer/Unslicer pair to implement this functionality.
Likewise the oldpb <tt class="docutils literal"><span class="pre">Cacheable</span></tt> class would need to be implemented
with a custom Slicer/Unslicer pair.</p>
<div class="section" id="copyable">
<h2>Copyable<a class="headerlink" href="#copyable" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to send your own classes over the wire is to use``Copyable`` . On the sending side, this requires two things: your
class must inherit from <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.Copyable-class.html">foolscap.Copyable</a> , and it
must define an attribute named <tt class="docutils literal"><span class="pre">typeToCopy</span></tt> with a unique string.
This copytype string is shared between both sides, so it is a good idea to
use a stable and globally unique value: perhaps a URL rooted in a namespace
that you control, or a UUID, or perhaps the fully-qualified
package+module+class name of the class being serialized. Any string will do,
as long as it matches the one used on the receiving side.</p>
<p>The object being sent is asked to provide a state dictionary by calling
its <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable.ICopyable-class.html#getStateToCopy">getStateToCopy</a> method. The default
implementation of <tt class="docutils literal"><span class="pre">getStateToCopy</span></tt> will simply return``self.__dict__`` . You can override <tt class="docutils literal"><span class="pre">getStateToCopy</span></tt> to
control what pieces of the source object get copied to the target. In
particular, you may want to override <tt class="docutils literal"><span class="pre">getStateToCopy</span></tt> if there is
any portion of the object&#8217;s state that should <strong>not</strong> be sent over the
wire: references to objects that can not or should not be serialized, or
things that are private to the application. It is common practice to create
an empty dictionary in this method and then copy items into it.</p>
<p>On the receiving side, you must register the copytype and provide a
function to deserialize the state dictionary back into an instance. For each``Copyable`` subclass you will create a corresponding <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.RemoteCopy-class.html">RemoteCopy</a> subclass. There are three
requirements which must be fulfilled by this subclass:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">copytype</span></tt> : Each <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> needs a
<tt class="docutils literal"><span class="pre">copytype</span></tt> attribute which contains the same string as the
corresponding <tt class="docutils literal"><span class="pre">Copyable</span></tt> &#8216;s <tt class="docutils literal"><span class="pre">typeToCopy</span></tt> attribute.
(metaclass magic is used to auto-register the <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> class
in the global copytype-to-RemoteCopy table when the class is defined. You
can also use <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap-class.html#registerRemoteCopy">foolscap.registerRemoteCopy</a> to
manually register a class).</li>
<li><tt class="docutils literal"><span class="pre">__init__</span></tt> : The <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> subclass must have
an __init__ method that takes no arguments. When the receiving side is
creating the incoming object, it starts by creating a new instance of the
correct <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> subclass, and at this point it has no
arguments to work with. Later, once the instance is created, it will
call <tt class="docutils literal"><span class="pre">setCopyableState</span></tt> to populate it.</li>
<li><tt class="docutils literal"><span class="pre">setCopyableState</span></tt> : Your <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> subclass
must define a method named <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable.IRemoteCopy-class.html#setCopyableState">setCopyableState</a> . This method
will be called with the state dictionary that came out of
<tt class="docutils literal"><span class="pre">getStateToCopy</span></tt> on the sending side, and is expected to set any
necessary internal state.</li>
</ol>
<p>Note that <tt class="docutils literal"><span class="pre">RemoteCopy</span></tt> is a new-style class: if you want your
copies to be old-style classes, inherit from <tt class="docutils literal"><span class="pre">RemoteCopyOldStyle</span></tt>
and manually register the copytype-to-subclass mapping with``registerRemoteCopy`` .</p>
<p><tt class="xref download docutils literal"><span class="pre">copyable-send.py</span></tt></p>
<p><tt class="xref download docutils literal"><span class="pre">copyable-receive.py</span></tt></p>
</div>
<div class="section" id="registering-copiers-to-serialize-third-party-classes">
<h2>Registering Copiers to serialize third-party classes<a class="headerlink" href="#registering-copiers-to-serialize-third-party-classes" title="Permalink to this headline">¶</a></h2>
<p>If you wish to serialize instances of third-party classes that are out of
your control (or you simply want to avoid subclassing), you can register a
Copier to provide serialization mechanisms for those instances.</p>
<p>There are plenty of cases where it is difficult to arrange for all of the
data you send over the wire to be in the form of <tt class="docutils literal"><span class="pre">Copyable</span></tt>
subclasses. For example, you might have a codebase that produces a
deeply-nested data structure that contains instances of pre-existing classes.
Those classes are written by other people, and do not happen to inherit from``Copyable`` . Without Copiers, you would have to traverse the whole
structure, locate all instances of these non-<tt class="docutils literal"><span class="pre">Copyable</span></tt> classes,
and wrap them in some new <tt class="docutils literal"><span class="pre">Copyable</span></tt> subclass. Registering a
Copier for the third-party class is much easier.</p>
<p>The <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable-class.html#registerCopier">registerCopier</a>
function is used to provide a &#8220;copier&#8221; for any given class. This copier is a
function that accepts an instance of the given class, and returns a
(copytype, state) tuple. For example <a class="footnote-reference" href="#id2" id="id1">[1]</a> , the xmlrpclib module
provides a <tt class="docutils literal"><span class="pre">DateTime</span></tt> class, and you might have a data structure
that includes some instances of them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">xmlrpclib</span>
<span class="kn">from</span> <span class="nn">foolscap</span> <span class="kn">import</span> <span class="n">registerCopier</span>

<span class="k">def</span> <span class="nf">copy_DateTime</span><span class="p">(</span><span class="n">xd</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot;_xmlrpclib_DateTime&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">xd</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>

<span class="n">registerCopier</span><span class="p">(</span><span class="n">xmlrpclib</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">copy_DateTime</span><span class="p">)</span>
</pre></div>
</div>
<p>This insures that any <tt class="docutils literal"><span class="pre">xmlrpclib.DateTime</span></tt> that is encountered
while serializing arguments or return values will be serialized with a
copytype of &#8220;_xmlrpclib_DateTime&#8221; and a state dictionary containing the
single &#8220;value&#8221; key. Even <tt class="docutils literal"><span class="pre">DateTime</span></tt> instances that appear
arbitrarily deep inside nested data structures will be serialized this way.
For example, one a method argument might be dictionary, and one of its keys
was a list, and that list could containe a <tt class="docutils literal"><span class="pre">DateTime</span></tt>
instance.</p>
<p>To deserialize this object, the receiving side needs to register a
corresponding deserializer. <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable-class.html#registerRemoteCopyFactory">registerRemoteCopyFactory</a> is the
receiving-side parallel to <tt class="docutils literal"><span class="pre">registerCopier</span></tt> . It associates a
copytype with a function that will receive a state dictionary and is expected
to return a fully-formed instance. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">xmlrpclib</span>
<span class="kn">from</span> <span class="nn">foolscap</span> <span class="kn">import</span> <span class="n">registerRemoteCopyFactory</span>

<span class="k">def</span> <span class="nf">make_DateTime</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">xmlrpclib</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">])</span>

<span class="n">registerRemoteCopyFactory</span><span class="p">(</span><span class="s">&quot;_xmlrpclib_DateTime&quot;</span><span class="p">,</span> <span class="n">make_DateTime</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the &#8220;_xmlrpclib_DateTime&#8221; copytype <strong>must</strong> be the same for
both the copier and the RemoteCopyFactory, otherwise the receiving side will
be unable to locate the correct deserializer.</p>
<p>It is perfectly reasonable to include both of these function/registration
pairs in the same module, and import it in the code on both sides of the
wire. The examples describe the sending and receiving sides separately to
emphasize the fact that the recipient may be running completely different
code than the sender.</p>
</div>
<div class="section" id="registering-icopyable-adapters">
<h2>Registering ICopyable adapters<a class="headerlink" href="#registering-icopyable-adapters" title="Permalink to this headline">¶</a></h2>
<p>A slightly more generalized way to teach Foolscap about third-party
classes is to register an <a class="reference external" href="http://foolscap.lothar.com/docs/api/foolscap.copyable.ICopyable-class.html">ICopyable</a> adapter for them, using the usual
(i.e. zope.interface) adapter-registration mechanism. The object that provide``ICopyable`` needs to implement two methods:<tt class="docutils literal"><span class="pre">getTypeToCopy</span></tt> (which returns the copytype), and``getStateToCopy`` , which returns the state dictionary. Any object
which can be adapted to <tt class="docutils literal"><span class="pre">ICopyable</span></tt> can be serialized this
way.</p>
<p>On the receiving side, the copytype is looked up in the``CopyableRegistry`` to find a corresponding UnslicerFactory. The``registerRemoteCopyUnslicerFactory`` function accepts two
arguments: the copytype, and the unslicer factory to use. This unslicer
factory is simply a function that takes no arguments and returns a new
Unslicer. Each time an inbound message with the matching copytype is
received, ths unslicer factory is invoked to create an Unslicer that will be
responsible for the single instance described in the message. This Unslicer
must implement an interface described in the <a class="reference internal" href="specifications/pb.html"><em>Unslicer specifications</em></a> .</p>
</div>
<div class="section" id="registering-islicer-adapters">
<h2>Registering ISlicer adapters<a class="headerlink" href="#registering-islicer-adapters" title="Permalink to this headline">¶</a></h2>
<p>The most generalized way to serialize classes is to register a whole``ISlicer`` adapter for them. The <tt class="docutils literal"><span class="pre">ISlicer</span></tt> gets complete
control over serialization: it can stall the production of tokens by
implementing a <tt class="docutils literal"><span class="pre">slice</span></tt> method that yields Deferreds instead of
basic objects. It can also interact with other objects while the target is
being serialized. As an extreme example, if you had a service that wanted to
migrate an open HTTP connection from one process to another, the``ISlicer`` could communication with a front-end load-balancing box
to redirect the connection to the new host. In this case, the slicer could
theoretically tell the load-balancer to pause the connection and assign it a
rendezvous number, then serialize this rendezvous number as a form of &#8220;claim
check&#8221; to the target process. The <tt class="docutils literal"><span class="pre">IUnslicer</span></tt> on the receiving end
could open a new listening port, then use the claim check to tell the
load-balancer to direct the connection to this new port. Likewise two
services running on the same host could conspire to pass open file
descriptors over a Foolscap connection (via an auxilliary unix-domain socket)
through suitable magic in the <tt class="docutils literal"><span class="pre">ISlicer</span></tt> and <tt class="docutils literal"><span class="pre">IUnslicer</span></tt>
on each end.</p>
<p>The Slicers and Unslicers are described in more detail in the <a class="reference internal" href="specifications/pb.html"><em>specifications</em></a> .</p>
<p>Note that a <tt class="docutils literal"><span class="pre">Copyable</span></tt> with a copytype of &#8220;foo&#8221; is serialized
as the following token stream: OPEN, &#8220;copyable&#8221;, &#8220;foo&#8221;, [state dictionary..],
CLOSE. Any <tt class="docutils literal"><span class="pre">ISlicer</span></tt> adapter which wishes to match what``Copyable`` does needs to include the extra &#8220;copyable&#8221; opentype
string first.</p>
<p>Also note that using a custom Slicer introduces an opportunity to violate
serialization coherency. <tt class="docutils literal"><span class="pre">Copyable</span></tt> and Copiers transform the
original object into a state dictionary in one swell foop, not allowing any
other code to get control (and possibly mutate the object&#8217;s state). If your
custom Slicer allows other code to get control during serialization, then the
object&#8217;s state might be changed, and thus the serialized state dictionary
could wind up looking pretty weird.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>many thanks to
Ricky Iacovou for the xmlrpclib.DateTime example</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using Pass-By-Copy in Foolscap</a><ul>
<li><a class="reference internal" href="#copyable">Copyable</a></li>
<li><a class="reference internal" href="#registering-copiers-to-serialize-third-party-classes">Registering Copiers to serialize third-party classes</a></li>
<li><a class="reference internal" href="#registering-icopyable-adapters">Registering ICopyable adapters</a></li>
<li><a class="reference internal" href="#registering-islicer-adapters">Registering ISlicer adapters</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="using-foolscap.html"
                        title="previous chapter">Introduction to Foolscap</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="failures.html"
                        title="next chapter">Foolscap Failure Reporting</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/copyable.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="failures.html" title="Foolscap Failure Reporting"
             >next</a> |</li>
        <li class="right" >
          <a href="using-foolscap.html" title="Introduction to Foolscap"
             >previous</a> |</li>
        <li><a href="index.html">Foolscap v0.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Brian Warner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>